import e,{useCallback as t,useEffect as r}from"react";import o from"auth0-js";import{useService as a}from"@xstate/react";import{Machine as n,assign as s,interpret as i}from"xstate";function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e}).apply(this,arguments)}const c=i(n({id:"useAuth",initial:"unauthenticated",context:{user:{},expiresAt:null,authResult:null,isAuthenticating:!1,error:void 0,errorType:void 0,config:{navigate:()=>console.error("Please specify a navigation method that works with your router"),callbackDomain:"http://localhost:8000",customPropertyNamespace:"http://localhost:8000"}},states:{unauthenticated:{on:{LOGIN:"authenticating",SET_CONFIG:{actions:["setConfig"]}}},authenticating:{on:{ERROR:"error",AUTHENTICATED:"authenticated",SET_CONFIG:{actions:["setConfig"]}},entry:["startAuthenticating"],exit:["stopAuthenticating"]},authenticated:{on:{LOGOUT:"unauthenticated",SET_CONFIG:{actions:["setConfig"]}},entry:["saveUserToContext","saveToLocalStorage"],exit:["clearUserFromContext","clearLocalStorage"]},error:{entry:["saveErrorToContext","clearUserFromContext","clearLocalStorage"]}}},{actions:{startAuthenticating:s(e=>({isAuthenticating:!0})),stopAuthenticating:s(e=>({isAuthenticating:!1})),saveUserToContext:s((e,t)=>{const{authResult:r,user:o}=t;return{user:o,authResult:r,expiresAt:1e3*r.expiresIn+(new Date).getTime()}}),clearUserFromContext:s(e=>({user:{},expiresAt:null,authResult:null})),saveToLocalStorage:(e,t)=>{const{expiresAt:r,user:o}=e;"undefined"!=typeof localStorage&&(localStorage.setItem("useAuth:expires_at",JSON.stringify(r)),localStorage.setItem("useAuth:user",JSON.stringify(o)))},clearLocalStorage:()=>{"undefined"!=typeof localStorage&&(localStorage.removeItem("useAuth:expires_at"),localStorage.removeItem("useAuth:user"))},saveErrorToContext:s((e,t)=>({errorType:t.errorType,error:t.error})),setConfig:s((e,t)=>(console.log("SET CONFIG",e,t),{config:u({},e.config,t)}))}}));c.start(),function(e){if("undefined"!=typeof localStorage){const t=new Date(JSON.parse(localStorage.getItem("useAuth:expires_at")||"0"));if(t>new Date){const r=JSON.parse(localStorage.getItem("useAuth:user")||"{}");e("LOGIN"),e("AUTHENTICATED",{user:r,authResult:{expiresIn:((new Date).getTime()-t.getTime())/1e3}})}}}(c.send);const l=()=>{const[e,r]=a(c),{authProvider:o,navigate:n,callbackDomain:s,customPropertyNamespace:i}=e.context.config,u=t(({postLoginRoute:e="/"}={})=>{o&&n&&s?"undefined"!=typeof window&&(r("LOGIN"),o.parseHash(async(t,a)=>{await(async({err:e,dispatch:t,authProvider:r,authResult:o})=>{if(!(o&&o.accessToken&&o.idToken))return!!e&&(console.error(e),t("ERROR",{error:e,errorType:"authResult"}),!1);try{return await(async({dispatch:e,authProvider:t,authResult:r})=>new Promise((o,a)=>{t.client.userInfo(r.accessToken||"",(t,n)=>{t?(e("ERROR",{errorType:"userInfo",error:t}),a(t)):(e("AUTHENTICATED",{authResult:r,user:n}),o(n))})}))({dispatch:t,authProvider:r,authResult:o}),!0}catch(e){return!1}})({err:t,authResult:a,dispatch:r,authProvider:o}),n(e)})):console.warn("authProvider not configured yet")},[o,n,s]),l=()=>!!(e.context.expiresAt&&(new Date).getTime()<e.context.expiresAt);return{isAuthenticating:e.context.isAuthenticating,isAuthenticated:l,isAuthorized:t=>{const r=Array.isArray(t)?t:[t],o=e.context.user[(i+"/user_metadata").replace(/\/+user_metadata/,"/user_metadata")];return!(!l()||!o)&&r.some(e=>o.roles.includes(e))},user:e.context.user,userId:e.context.user?e.context.user.sub:null,authResult:e.context.authResult,login:()=>{o&&o.authorize()},signup:()=>{o&&o.authorize({mode:"signUp",screen_hint:"signup"})},logout:()=>{o&&o.logout({returnTo:s}),r("LOGOUT"),n("/")},handleAuthentication:u,dispatch:r}},h=({children:t,navigate:a,auth0_audience_domain:n,auth0_domain:s,auth0_client_id:i,auth0_params:c,customPropertyNamespace:h})=>{const p="undefined"!=typeof window?`${window.location.protocol}//${window.location.host}`:"http://localhost:8000",d={domain:s,clientID:i,redirectUri:p+"/auth0_callback",audience:`https://${n||s}/api/v2/`,responseType:"token id_token",scope:"openid profile email"},{dispatch:g}=l();return r(()=>{const e=new o.WebAuth(u({},d,c));g("SET_CONFIG",{authProvider:e,navigate:a,customPropertyNamespace:h,callbackDomain:p})},[a,h,p]),e.createElement(e.Fragment,null,t)};export{h as AuthProvider,l as useAuth};
//# sourceMappingURL=index.modern.js.map
