import e,{createContext as t,useState as r,useEffect as n,useContext as o,useCallback as a}from"react";import u from"auth0-js";import{useService as i}from"@xstate/react";import{Machine as s,assign as c,interpret as l}from"xstate";function h(){return(h=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var m=t({auth0:null,callback_domain:"http://localhost:8000",customPropertyNamespace:"http://localhost:8000",navigate:e=>{}}),p=t=>{var{children:o,navigate:a,auth0_audience_domain:i,auth0_domain:s,auth0_client_id:c,auth0_params:l,customPropertyNamespace:p}=t,d="undefined"!=typeof window?window.location.protocol+"//"+window.location.host:"http://localhost:8000",f=new u.WebAuth(h({},{domain:s,clientID:c,redirectUri:d+"/auth0_callback",audience:"https://"+(i||s)+"/api/v2/",responseType:"token id_token",scope:"openid profile email"},{},l)),[g,y]=r({auth0:f,callback_domain:d,customPropertyNamespace:p,navigate:a});return n(()=>{y(e=>h({},e))},[]),e.createElement(m.Provider,{value:g},o)};"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var d=l(s({id:"useAuth",initial:"unauthenticated",context:{user:{},expiresAt:null,authResult:null,isAuthenticating:!1,error:void 0,errorType:void 0},states:{unauthenticated:{on:{LOGIN:"authenticating"}},authenticating:{on:{ERROR:"error",AUTHENTICATED:"authenticated"},entry:["startAuthenticating"],exit:["stopAuthenticating"]},authenticated:{on:{LOGOUT:"unauthenticated"},entry:["saveUserToContext","saveToLocalStorage"],exit:["clearUserFromContext","clearLocalStorage"]},error:{entry:["saveErrorToContext","clearUserFromContext","clearLocalStorage"]}}},{actions:{startAuthenticating:c((function(e){return{isAuthenticating:!0}})),stopAuthenticating:c((function(e){return{isAuthenticating:!1}})),saveUserToContext:c((function(e,t){var r=t.authResult;return{user:t.user,authResult:r,expiresAt:1e3*r.expiresIn+(new Date).getTime()}})),clearUserFromContext:c((function(e){return{user:{},expiresAt:null,authResult:null}})),saveToLocalStorage:function(e,t){var r=e.user;"undefined"!=typeof localStorage&&(localStorage.setItem("useAuth:expires_at",JSON.stringify(e.expiresAt)),localStorage.setItem("useAuth:user",JSON.stringify(r)))},clearLocalStorage:function(){"undefined"!=typeof localStorage&&(localStorage.removeItem("useAuth:expires_at"),localStorage.removeItem("useAuth:user"))},saveErrorToContext:c((function(e,t){return{errorType:t.errorType,error:t.error}}))}}));d.start(),function(e){if("undefined"!=typeof localStorage){var t=new Date(JSON.parse(localStorage.getItem("useAuth:expires_at")||"0"));if(t>new Date){var r=JSON.parse(localStorage.getItem("useAuth:user")||"{}");e("LOGIN"),e("AUTHENTICATED",{user:r,authResult:{expiresIn:((new Date).getTime()-t.getTime())/1e3}})}}}(d.send);var f=function(){var e=o(m),t=e.auth0,r=e.callback_domain,n=e.navigate,u=e.customPropertyNamespace,s=i(d),c=s[0],l=s[1],p=a((function(e,t){l(h({type:e},t||{}))}),[l]),f=function(){return!!(c.context.expiresAt&&(new Date).getTime()<c.context.expiresAt)};return{isAuthenticating:c.context.isAuthenticating,isAuthenticated:f,isAuthorized:function(e){var t=Array.isArray(e)?e:[e],r=c.context.user[(u+"/user_metadata").replace(/\/+user_metadata/,"/user_metadata")];return!(!f()||!r)&&t.some((function(e){return r.roles.includes(e)}))},user:c.context.user,userId:c.context.user?c.context.user.sub:null,authResult:c.context.authResult,login:function(){t&&t.authorize()},signup:function(){t&&t.authorize({mode:"signUp",screen_hint:"signup"})},logout:function(){t&&t.logout({returnTo:r}),p("LOGOUT"),n("/")},handleAuthentication:function(e){var r=(void 0===e?{}:e).postLoginRoute,o=void 0===r?"/":r;"undefined"!=typeof window&&(p("LOGIN"),t&&t.parseHash((function(e,r){try{return Promise.resolve(function(e){var t=e.err,r=e.send,n=e.auth0,o=e.authResult;try{return o&&o.accessToken&&o.idToken?Promise.resolve(function(e,t){try{var a=Promise.resolve(function(e){var t=e.send,r=e.auth0,n=e.authResult;try{return Promise.resolve(new Promise((function(e,o){r.client.userInfo(n.accessToken||"",(function(r,a){r?(t("ERROR",{errorType:"userInfo",error:r}),o(r)):(t("AUTHENTICATED",{authResult:n,user:a}),e(a))}))})))}catch(e){return Promise.reject(e)}}({send:r,auth0:n,authResult:o})).then((function(){return!0}))}catch(e){return!1}return a&&a.then?a.then(void 0,(function(){return!1})):a}()):t?(console.error(t),r("ERROR",{error:t,errorType:"authResult"}),Promise.resolve(!1)):Promise.resolve(!1)}catch(e){return Promise.reject(e)}}({err:e,authResult:r,send:p,auth0:t})).then((function(){n(o)}))}catch(e){return Promise.reject(e)}})))}}};export{p as AuthProvider,f as useAuth};
//# sourceMappingURL=index.module.js.map
