import t,{createContext as e,useState as r,useEffect as n,useContext as o}from"react";import a from"auth0-js";import{Machine as u,assign as i,interpret as s}from"xstate";import{useService as c}from"@xstate/react";function l(){return(l=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}var h=e({auth0:null,callback_domain:"http://localhost:8000",customPropertyNamespace:"http://localhost:8000",navigate:function(t){}}),m=function(e){var o=e.children,u=e.navigate,i=e.auth0_domain,s=e.customPropertyNamespace,c="undefined"!=typeof window?window.location.protocol+"//"+window.location.host:"http://localhost:8000",m=new a.WebAuth(l({},{domain:i,clientID:e.auth0_client_id,redirectUri:c+"/auth0_callback",audience:"https://"+(e.auth0_audience_domain||i)+"/api/v2/",responseType:"token id_token",scope:"openid profile email"},{},e.auth0_params)),p=r({auth0:m,callback_domain:c,customPropertyNamespace:s,navigate:u}),d=p[0],f=p[1];return n((function(){f((function(t){return l({},t)}))}),[]),t.createElement(h.Provider,{value:d},o)};"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var p=u({id:"useAuth",initial:"unauthenticated",context:{user:{},expiresAt:null,authResult:null,isAuthenticating:!1,error:void 0,errorType:void 0},states:{unauthenticated:{on:{LOGIN:"authenticating"}},authenticating:{on:{ERROR:"error",AUTHENTICATED:"authenticated"},entry:["startAuthenticating"],exit:["stopAuthenticating"]},authenticated:{on:{LOGOUT:"unauthenticated"},entry:["saveUserToContext","saveToLocalStorage"],exit:["clearUserFromContext","clearLocalStorage"]},error:{entry:["saveErrorToContext","clearUserFromContext","clearLocalStorage"]}}},{actions:{startAuthenticating:i((function(t){return{isAuthenticating:!0}})),stopAuthenticating:i((function(t){return{isAuthenticating:!1}})),saveUserToContext:i((function(t,e){var r=e.authResult;return{user:e.user,authResult:r,expiresAt:1e3*r.expiresIn+(new Date).getTime()}})),clearUserFromContext:i((function(t){return{user:{},expiresAt:null,authResult:null}})),saveToLocalStorage:function(t,e){var r=t.user;"undefined"!=typeof localStorage&&(localStorage.setItem("useAuth:expires_at",JSON.stringify(t.expiresAt)),localStorage.setItem("useAuth:user",JSON.stringify(r)))},clearLocalStorage:function(){"undefined"!=typeof localStorage&&(localStorage.removeItem("useAuth:expires_at"),localStorage.removeItem("useAuth:user"))},saveErrorToContext:i((function(t,e){return{errorType:e.errorType,error:e.error}}))}}),d=(s(p),function(t){var e=t.err,r=t.send,n=t.auth0,o=t.authResult;try{return o&&o.accessToken&&o.idToken?Promise.resolve(function(t,e){try{var a=Promise.resolve(function(t){var e=t.send,r=t.auth0,n=t.authResult;try{return Promise.resolve(new Promise((function(t,o){r.client.userInfo(n.accessToken||"",(function(r,a){r?(e("ERROR",{errorType:"userInfo",error:r}),o(r)):(e("AUTHENTICATED",{authResult:n,user:a}),t(a))}))})))}catch(t){return Promise.reject(t)}}({send:r,auth0:n,authResult:o})).then((function(){return!0}))}catch(t){return!1}return a&&a.then?a.then(void 0,(function(){return!1})):a}()):e?(console.error(e),r("ERROR",{error:e,errorType:"authResult"}),Promise.resolve(!1)):Promise.resolve(!1)}catch(t){return Promise.reject(t)}}),f=s(p),y=function(){var t=o(h),e=t.auth0,r=t.callback_domain,n=t.navigate,a=t.customPropertyNamespace,u=c(f),i=u[0],s=u[1],l=function(){return!!(i.context.expiresAt&&(new Date).getTime()<i.context.expiresAt)};return{isAuthenticating:i.context.isAuthenticating,isAuthenticated:l,isAuthorized:function(t){var e=Array.isArray(t)?t:[t],r=i.context.user[(a+"/user_metadata").replace(/\/+user_metadata/,"/user_metadata")];return!(!l()||!r)&&e.some((function(t){return r.roles.includes(t)}))},user:i.context.user,userId:i.context.user?i.context.user.sub:null,authResult:i.context.authResult,login:function(){e&&e.authorize()},signup:function(){e&&e.authorize({mode:"signUp",screen_hint:"signup"})},logout:function(){e&&e.logout({returnTo:r}),s("LOGOUT"),n("/")},handleAuthentication:function(t){var r=(void 0===t?{}:t).postLoginRoute,o=void 0===r?"/":r;"undefined"!=typeof window&&(s("LOGIN"),e&&e.parseHash((function(t,r){try{return Promise.resolve(d({err:t,authResult:r,send:s,auth0:e})).then((function(){n(o)}))}catch(t){return Promise.reject(t)}})))}}};export{m as AuthProvider,y as useAuth};
//# sourceMappingURL=index.module.js.map
